OpenAI Codex v0.89.0 (research preview)
--------
workdir: /Users/chiko/side_projects/usdt_blacklisted_web
model: gpt-5.2
provider: openai
approval: never
sandbox: danger-full-access
reasoning effort: high
reasoning summaries: auto
session id: 019be92a-854b-7a21-aa70-3f5d83890cd6
--------
user
# Build

You are an autonomous coding agent. Your task is to complete the work for exactly one story and record the outcome.

## Paths
- PRD: /Users/chiko/side_projects/usdt_blacklisted_web/.agents/tasks/prd-post-mvp.json
- AGENTS (optional): /Users/chiko/side_projects/usdt_blacklisted_web/AGENTS.md
- Progress Log: /Users/chiko/side_projects/usdt_blacklisted_web/.ralph/progress.md
- Guardrails: /Users/chiko/side_projects/usdt_blacklisted_web/.ralph/guardrails.md
- Guardrails Reference: /Users/chiko/side_projects/usdt_blacklisted_web/.agents/ralph/references/GUARDRAILS.md
- Context Reference: /Users/chiko/side_projects/usdt_blacklisted_web/.agents/ralph/references/CONTEXT_ENGINEERING.md
- Errors Log: /Users/chiko/side_projects/usdt_blacklisted_web/.ralph/errors.log
- Activity Log: /Users/chiko/side_projects/usdt_blacklisted_web/.ralph/activity.log
- Activity Logger: /Users/chiko/side_projects/usdt_blacklisted_web/ralph log
- No-commit: false
- Repo Root: /Users/chiko/side_projects/usdt_blacklisted_web
- Run ID: 20260123-044356-6274
- Iteration: 1
- Run Log: /Users/chiko/side_projects/usdt_blacklisted_web/.ralph/runs/run-20260123-044356-6274-iter-1.log
- Run Summary: /Users/chiko/side_projects/usdt_blacklisted_web/.ralph/runs/run-20260123-044356-6274-iter-1.md

## Global Quality Gates (apply to every story)
- pnpm lint
- pnpm test
- pnpm build

## Selected Story (Do not change scope)
ID: US-001
Title: [P2] Decide DB + ORM and document data retention policy

Story details:
### US-001: [P2] Decide DB + ORM and document data retention policy
Status: in_progress
Depends on: None

Description:
As the maintainer, I want a documented decision for database provider and ORM (plus retention/privacy policy) so that report saving can be implemented consistently and safely.

Acceptance Criteria:
- [ ] Add an ADR-style doc that selects: Postgres provider approach (e.g., Neon/Vercel Postgres) and ORM choice (Drizzle or Prisma) with rationale and tradeoffs.
- [ ] Define a retention policy (e.g., unlimited by default with optional caps) and explicitly state what is stored when loggingEnabled is true vs false.
- [ ] Update `.env.example` with any required env vars for the chosen approach (e.g., `DATABASE_URL`, `ADDRESS_HASH_KEY` or equivalent).
- [ ] Example: Doc includes a worked example of saving a report and what fields are persisted.
- [ ] Negative case: Doc explicitly covers what happens when `DATABASE_URL` is missing (features disabled gracefully; app still builds).


If the story details are empty or missing, STOP and report that the PRD story format could not be parsed.

## Rules (Non-Negotiable)
- Implement **only** the work required to complete the selected story.
- Complete all tasks associated with this story (and only this story).
- Do NOT ask the user questions.
- Do NOT change unrelated code.
- Do NOT assume something is unimplemented — confirm by reading code.
- Implement completely; no placeholders or stubs.
- If No-commit is true, do NOT commit or push changes.
- Do NOT edit the PRD JSON (status is handled by the loop).
- All changes made during the run must be committed (including updates to progress/logs).
 - Before committing, perform a final **security**, **performance**, and **regression** review of your changes.

## Your Task (Do this in order)
1. Read /Users/chiko/side_projects/usdt_blacklisted_web/.ralph/guardrails.md before any code changes.
2. Read /Users/chiko/side_projects/usdt_blacklisted_web/.ralph/errors.log for repeated failures to avoid.
3. Read /Users/chiko/side_projects/usdt_blacklisted_web/.agents/tasks/prd-post-mvp.json for global context (do not edit).
4. Fully audit and read all necessary files to understand the task end-to-end before implementing. Do not assume missing functionality.
5. If /Users/chiko/side_projects/usdt_blacklisted_web/AGENTS.md exists, follow its build/test instructions.
6. Implement only the tasks that belong to US-001.
7. Run verification commands listed in the story, the global quality gates, and in /Users/chiko/side_projects/usdt_blacklisted_web/AGENTS.md (if required).
8. If the project has a build or dev workflow, run what applies:
   - Build step (e.g., `npm run build`) if defined.
   - Dev server (e.g., `npm run dev`, `wrangler dev`) if it is the normal validation path.
   - Confirm no runtime/build errors in the console.
9. Perform a brief audit before committing:
   - **Security:** check for obvious vulnerabilities or unsafe handling introduced by your changes.
   - **Performance:** check for avoidable regressions (extra queries, heavy loops, unnecessary re-renders).
   - **Regression:** verify existing behavior that could be impacted still works.
10. If No-commit is false, commit changes using the `$commit` skill.
    - Stage everything: `git add -A`
    - Confirm a clean working tree after commit: `git status --porcelain` should be empty.
    - After committing, capture the commit hash and subject using:
      `git show -s --format="%h %s" HEAD`.
11. Append a progress entry to /Users/chiko/side_projects/usdt_blacklisted_web/.ralph/progress.md with run/commit/test details (format below).
    If No-commit is true, skip committing and note it in the progress entry.

## Progress Entry Format (Append Only)
```
## [Date/Time] - US-001: [P2] Decide DB + ORM and document data retention policy
Thread: [codex exec session id if available, otherwise leave blank]
Run: 20260123-044356-6274 (iteration 1)
Run log: /Users/chiko/side_projects/usdt_blacklisted_web/.ralph/runs/run-20260123-044356-6274-iter-1.log
Run summary: /Users/chiko/side_projects/usdt_blacklisted_web/.ralph/runs/run-20260123-044356-6274-iter-1.md
- Guardrails reviewed: yes
- No-commit run: false
- Commit: <hash> <subject> (or `none` + reason)
- Post-commit status: `clean` or list remaining files
- Verification:
  - Command: <exact command> -> PASS/FAIL
  - Command: <exact command> -> PASS/FAIL
- Files changed:
  - <file path>
  - <file path>
- What was implemented
- **Learnings for future iterations:**
  - Patterns discovered
  - Gotchas encountered
  - Useful context
---
```

## Completion Signal
Only output the completion signal when the **selected story** is fully complete and verified.
When the selected story is complete, output:
<promise>COMPLETE</promise>

Otherwise, end normally without the signal.

## Additional Guardrails
- When authoring documentation, capture the why (tests + implementation intent).
- If you learn how to run/build/test the project, update /Users/chiko/side_projects/usdt_blacklisted_web/AGENTS.md briefly (operational only).
- Keep AGENTS operational only; progress notes belong in /Users/chiko/side_projects/usdt_blacklisted_web/.ralph/progress.md.
- If you hit repeated errors, log them in /Users/chiko/side_projects/usdt_blacklisted_web/.ralph/errors.log and add a Sign to /Users/chiko/side_projects/usdt_blacklisted_web/.ralph/guardrails.md using /Users/chiko/side_projects/usdt_blacklisted_web/.agents/ralph/references/GUARDRAILS.md as the template.

## Activity Logging (Required)
Log major actions to /Users/chiko/side_projects/usdt_blacklisted_web/.ralph/activity.log using the helper:
```
/Users/chiko/side_projects/usdt_blacklisted_web/ralph log "message"
```
Log at least:
- Start of work on the story
- After major code changes
- After tests/verification
- After updating progress log

## Browser Testing (Required for Frontend Stories)
If the selected story changes UI, you MUST verify it in the browser:
1. Load the `dev-browser` skill.
2. Navigate to the relevant page.
3. Verify the UI changes work as expected.
4. Take a screenshot if helpful for the progress log.

A frontend story is NOT complete until browser verification passes.

mcp startup: no servers






thinking
**Evaluating database setup**

First, I'm considering the repo and the choice of provider for Next.js on Vercel. Should I go with Neon or Vercel Postgres? I need to choose an ORM too—either Drizzle or Prisma. I think I prefer Neon Postgres with Drizzle because it supports TypeScript and fits with edge functions. Drizzle feels lightweight, which is good. 

Next, I need to define a retention policy. I’ll check what gets stored when logging is enabled or disabled. I should ensure documentation reflects this accurately.
thinking
**Defining data retention policies**

I need to outline the storage of addresses, ensuring we only store hashed addresses using HMAC with a specific key. It's important to include additional data like timestamps and risk scores while avoiding raw addresses or personally identifiable information. For the retention policy, I’ll set it to be unlimited by default but only for persisted reports with hashed addresses. 

I'll also introduce an environment variable for retention days and make sure others, like `DATABASE_URL` and `ADDRESS_HASH_KEY`, are documented and updated in `.env.example`. If `DATABASE_URL` is missing, I'll clarify that report persistence is disabled.
thinking
**Implementing report persistence checks**

To fully implement the requirement of no placeholders, I may need to add actual guards in code for any existing report-saving feature. The documentation should state that features are gracefully disabled if `DATABASE_URL` is missing, which suggests I’ll need to implement some checks or update the docs to clarify current behavior. 

If report saving isn’t available yet, I should still indicate that future features will be disabled. I must confirm the existence of logging/report persistence under the environment flag, ensuring it functions correctly without crashing when `DATABASE_URL` is absent.
thinking
**Handling environment variable checks**

I need to be careful not to go beyond the scope, but if we want to ensure the app builds despite missing the environment variable, I might need to modify the code to prevent runtime errors. The build should pass without `DB_URL`, but I must check if it still runs without crashing at runtime. If code attempts to use `process.env.DATABASE_URL` during import, it could fail.

I need to ensure that the database client module doesn’t initialize if this variable is missing, so I may need to implement a fix for that.
thinking
**Planning documentation and commits**

I’ll create a document for database and retention decisions, and update `.env.example` with necessary environment variables. It’s crucial to ensure safe runtime behavior when `DATABASE_URL` is absent, so I need to implement guards in the code. I also need to update the progress log after committing changes. 

I might have to make two commits: one for code and environment updates, and another for the progress log. The progress entry should identify the first commit, but ideally, I'd keep everything organized in one commit. I'll decide the best approach while sticking to the process flow.
thinking
**Planning documentation and commits**

I need to carefully consider my steps regarding commits and appending progress entries. While I could amend a commit to capture the new hash, it might be clearer to make two separate commits, one for the story changes and another for the progress log. This way, I can indicate the relationship between the commit hashes without deviating from the steps.

Additionally, I need to log activity and capture necessary documentation changes without implementing actual database features. I’ll also tackle tasks like checking logs, understanding context, deciding on the DB and ORM, and ensuring safety through hashing. Let’s create a clear plan with around 5-6 steps to tackle everything systematically!
Plan update
Implement US-001 by documenting DB/ORM and retention decisions, updating env examples, verifying quality gates, then recording outcome in required logs.
  → Review guardrails and prior errors
  • Audit current env and logging behavior
  • Write ADR and retention policy doc
  • Update .env.example and validate build
  • Run lint, tests, and build
  • Commit, log activity, update progress
exec
/bin/zsh -lc './ralph log "Start US-001: decide DB+ORM and document retention policy"' in /Users/chiko/side_projects/usdt_blacklisted_web exited 127 in 48ms:
zsh:1: no such file or directory: ./ralph
exec
/bin/zsh -lc 'ls -la .ralph .agents/tasks || true' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 58ms:
.agents/tasks:
total 88
drwxr-xr-x@ 5 chiko  staff    160 Jan 23 04:41 .
drwxr-xr-x@ 4 chiko  staff    128 Jan 23 04:36 ..
-rw-r--r--@ 1 chiko  staff  15120 Jan 23 04:23 prd-optin-dashboard.json
-rw-r--r--@ 1 chiko  staff    162 Jan 23 04:35 prd-optin-dashboard.overview.md
-rw-r--r--@ 1 chiko  staff  21869 Jan 23 04:43 prd-post-mvp.json

.ralph:
total 32
drwxr-xr-x@  8 chiko  staff   256 Jan 23 04:25 .
drwxr-xr-x@ 34 chiko  staff  1088 Jan 23 04:21 ..
drwxr-xr-x@ 15 chiko  staff   480 Jan 23 04:43 .tmp
-rw-r--r--@  1 chiko  staff   109 Jan 23 04:43 activity.log
-rw-r--r--@  1 chiko  staff    74 Jan 23 04:25 errors.log
-rw-r--r--@  1 chiko  staff   421 Jan 23 04:25 guardrails.md
-rw-r--r--@  1 chiko  staff   111 Jan 23 04:25 progress.md
drwxr-xr-x@  3 chiko  staff    96 Jan 23 04:43 runs
exec
/bin/zsh -lc "sed -n '1,200p' .ralph/guardrails.md" in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 63ms:
# Guardrails (Signs)

> Lessons learned from failures. Read before acting.

## Core Signs

### Sign: Read Before Writing
- **Trigger**: Before modifying any file
- **Instruction**: Read the file first
- **Added after**: Core principle

### Sign: Test Before Commit
- **Trigger**: Before committing changes
- **Instruction**: Run required tests and verify outputs
- **Added after**: Core principle

---

## Learned Signs

exec
/bin/zsh -lc 'cat .ralph/errors.log || true' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 60ms:
# Error Log

> Failures and repeated issues. Use this to add guardrails.

exec
/bin/zsh -lc 'cat .agents/tasks/prd-post-mvp.json' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 62ms:
{
  "version": 1,
  "project": "TRON USDT Screening \u2014 Complete Remaining PRD Tasks (P2\u2013P4)",
  "overview": "This PRD translates the remaining unchecked items in PRD.md (P2 opt-in report saving, P3 authenticated dashboard UX upgrades, and P4 credits/packaging) into small, implementable stories for the existing Next.js + Clerk codebase. Privacy-first defaults remain: no address logging unless an authenticated user explicitly opts in.",
  "goals": [
    "Add persistent, privacy-first opt-in report saving (history + deletion) for authenticated users.",
    "Add a post-login dashboard shell with dedicated screens (Overview, History, Watchlist, Settings).",
    "Add wallet visuals (balance/flows) and charts with evidence links and time-window controls.",
    "Document and scaffold future credits/billing/workspace/export capabilities without breaking current free flows."
  ],
  "nonGoals": [
    "Multi-chain support (TRON-only).",
    "Batch screening (single address only).",
    "Automated accept/reject recommendations (findings only).",
    "Requiring users to provide private keys/seed phrases.",
    "Logging or analytics that include raw addresses by default."
  ],
  "successMetrics": [
    "Authenticated users can enable saving, save a report, view it in History, and delete it (single and all) with default-off privacy behavior.",
    "Dashboard routes are accessible post-login and unauthenticated access is blocked/redirected.",
Plan update
  ✓ Review guardrails and prior errors
  → Audit current env and logging behavior
  • Write ADR and retention policy doc
  • Update .env.example and validate build
  • Run lint, tests, and build
  • Commit, log activity, update progress
exec
/bin/zsh -lc 'ls -la ralph || true' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 53ms:
ls: ralph: No such file or directory
exec
/bin/zsh -lc '/Users/chiko/side_projects/usdt_blacklisted_web/ralph log "Start US-001: decide DB+ORM and document retention policy"' in /Users/chiko/side_projects/usdt_blacklisted_web exited 127 in 53ms:
zsh:1: no such file or directory: /Users/chiko/side_projects/usdt_blacklisted_web/ralph
exec
/bin/zsh -lc 'ls -la' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 61ms:
total 2864
drwxr-xr-x@ 34 chiko  staff     1088 Jan 23 04:21 .
drwxr-xr-x@ 11 chiko  staff      352 Jan 21 18:51 ..
drwxr-xr-x@  4 chiko  staff      128 Jan 23 04:36 .agents
drwxr-xr-x@  3 chiko  staff       96 Jan 21 23:12 .clerk
-rw-r--r--@  1 chiko  staff     8196 Jan 21 19:22 .DS_Store
-rw-r--r--@  1 chiko  staff      461 Jan 22 13:07 .env
-rw-r--r--@  1 chiko  staff      356 Jan 22 13:19 .env.example
drwxr-xr-x@ 12 chiko  staff      384 Jan 23 04:29 .git
-rw-r--r--@  1 chiko  staff      567 Jan 21 23:12 .gitignore
drwxr-xr-x@ 25 chiko  staff      800 Jan 22 16:54 .next
drwxr-xr-x@  8 chiko  staff      256 Jan 23 04:25 .ralph
-rw-r--r--@  1 chiko  staff     2483 Jan 23 04:02 AGENTS.md
-rw-r--r--@  1 chiko  staff     1453 Jan 21 18:26 check-usdt-blacklist.js
-rw-r--r--@  1 chiko  staff     3562 Jan 22 12:40 CLAUDE.md
drwxr-xr-x@ 13 chiko  staff      416 Jan 22 01:07 coverage
-rw-r--r--@  1 chiko  staff      484 Jan 22 12:25 eslint.config.mjs
-rw-r--r--@  1 chiko  staff     1394 Jan 22 12:32 GPT.md
-rw-r--r--@  1 chiko  staff      716 Jan 21 23:17 middleware.ts
-rw-r--r--@  1 chiko  staff      251 Jan 22 16:57 next-env.d.ts
exec
/bin/zsh -lc 'rg -n "loggingEnabled|LOGGING_ENABLED|DATABASE_URL|prisma|drizzle|postgres" . -S' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 63ms:
./PRD.md:335:- [ ] Store user settings: `loggingEnabled` (default false).
./src/components/blacklist-checker.tsx:202:const LOGGING_PREF_KEY = "usdt_blacklisted_web:loggingEnabled";
./src/components/blacklist-checker.tsx:540:  const [loggingEnabled, setLoggingEnabled] = React.useState(false);
./src/components/blacklist-checker.tsx:899:                    checked={loggingEnabled}
./project_summary.md:324:- [ ] Store user settings: `loggingEnabled` (default false).
./project_summary.md:851:DATABASE_URL=
./project_summary.md:2003:const LOGGING_PREF_KEY = "usdt_blacklisted_web:loggingEnabled";
./project_summary.md:2341:  const [loggingEnabled, setLoggingEnabled] = React.useState(false);
./project_summary.md:2699:                    checked={loggingEnabled}
exec
/bin/zsh -lc "ls -la .env.example || true; sed -n '1,200p' .env.example || true" in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 64ms:
-rw-r--r--@ 1 chiko  staff  356 Jan 22 13:19 .env.example
TRONGRID_API_KEY=
NEXT_PUBLIC_SITE_URL=https://usdt.chikocorp.com

# Clerk (auth)
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=
CLERK_SECRET_KEY=
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/

# Database (future: opt-in report saving + credits)
DATABASE_URL=


thinking
**Addressing logging issues**

I'm facing an issue with the missing `ralph` executable, which is causing conflicts with logging major actions. There's an activity log file, but the helper command seems to be missing from the repo. I wonder if it could be created directly in the path. If the helper isn't available, I might need to note activities in the log instead. Perhaps we should implement a minimal helper script in the repo root? That may be necessary for compliance despite it not being part of the story US-001.
thinking
**Finding a logging solution**

I could write directly to `.ralph/activity.log` using `printf` and note in `.ralph/errors.log` that the helper is missing. However, instructions say to use the helper. If it’s absent, creating one might be necessary. I have to be cautious not to change unrelated code, but adding a `ralph` script shouldn’t affect the app. I’ll implement a small script to log timestamped messages and maybe support `ralph log "message"`. I'll check for a globally installed `ralph` command, but it seems like it doesn't exist.
exec
/bin/zsh -lc 'command -v ralph || true; ls -la .agents/ralph || true' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 48ms:
/Users/chiko/.nvm/versions/node/v23.3.0/bin/ralph
total 760
drwxr-xr-x@ 11 chiko  staff     352 Jan 23 04:36 .
drwxr-xr-x@  4 chiko  staff     128 Jan 23 04:36 ..
-rw-r--r--@  1 chiko  staff     868 Jan 23 04:36 agents.sh
-rw-r--r--@  1 chiko  staff    1058 Jan 23 04:36 config.sh
-rw-r--r--@  1 chiko  staff    2732 Jan 23 04:36 diagram.svg
-rwxr-xr-x@  1 chiko  staff     353 Jan 23 04:36 log-activity.sh
-rwxr-xr-x@  1 chiko  staff   27605 Jan 23 04:36 loop.sh
-rw-r--r--@  1 chiko  staff    5190 Jan 23 04:36 PROMPT_build.md
-rw-r--r--@  1 chiko  staff  275808 Jan 23 04:36 ralph.webp
-rw-r--r--@  1 chiko  staff    4907 Jan 23 04:36 README.md
drwxr-xr-x@  4 chiko  staff     128 Jan 23 04:36 references

thinking
**Running command in Node**

I need to run the global command `ralph`, which is installed in the Node bin. I'll go with `ralph log`. I realize I shouldn't use the previous path since it didn't work, so using `ralph log` without `./` seems like the right move. Let’s see how this goes! I’m feeling good about running the command correctly this time.
exec
/bin/zsh -lc 'ralph log "Start US-001: decide DB+ORM and document retention policy"' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 164ms:
Using local templates: /Users/chiko/side_projects/usdt_blacklisted_web/.agents/ralph

thinking
**Auditing logging and routes**

Alright, logging works with the global command, so any earlier failures were not necessary, and no code changes are needed. I'm planning to audit the current environment and the logging aspect. My next step is to search the code for the localStorage key. I'll focus on the blacklist-checker component related to logging and inspect existing API routes to see if logging is functional, though it seems unlikely there’s a database involved. I'll read relevant files in parallel, like `src/components/blacklist-checker.tsx` and the API routes.
exec
/bin/zsh -lc "ls -R src/app | sed -n '1,200p'" in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 49ms:
api
favicon.ico
globals.css
layout.tsx
page.tsx
sign-in
sign-up

src/app/api:
analyze
check

src/app/api/analyze:
route.ts

src/app/api/check:
route.ts

src/app/sign-in:
[[...sign-in]]
exec
/bin/zsh -lc "sed -n '150,260p' src/components/blacklist-checker.tsx" in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 34ms:
  notices: string[];
};

type LoadState =
  | { state: "idle" }
  | { state: "loading" }
  | { state: "success"; data: ApiResponse }
  | { state: "error"; message: string; status?: number; details?: string };

/* ────────────────────────────────────────────────────────────────────────────
 * Animation variants (respect reduced motion)
 * ──────────────────────────────────────────────────────────────────────────── */

const fadeInUp = {
  initial: { opacity: 0, y: 12 },
  animate: { opacity: 1, y: 0 },
  exit: { opacity: 0, y: -8 },
};

const staggerContainer = {
exec
/bin/zsh -lc "sed -n '520,660p' src/components/blacklist-checker.tsx" in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 30ms:
          <p className="mt-0.5 text-sm text-red-800/80 dark:text-red-200/70">
            No legitimate service can &quot;unblacklist&quot; an address for a fee. Never share your seed phrase.
          </p>
        </div>
      </div>
    </motion.div>
  );
}

/* ────────────────────────────────────────────────────────────────────────────
 * Main Component
 * ──────────────────────────────────────────────────────────────────────────── */

export function BlacklistChecker() {
  const m = getMessages("en");
  const clerkEnabled = Boolean(process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY);

  const [address, setAddress] = React.useState("");
  const [validation, setValidation] = React.useState<ReturnType<typeof validateTronAddress> | null>(null);
  const [load, setLoad] = React.useState<LoadState>({ state: "idle" });
exec
/bin/zsh -lc "ls -R src/lib | sed -n '1,200p'" in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 55ms:
aml.test.ts
aml.ts
cache.ts
entity.test.ts
entity.ts
exposure.test.ts
exposure.ts
heuristics.test.ts
heuristics.ts
i18n.ts
sanctions.test.ts
sanctions.ts
tron.ts
tronscan.ts
utils.ts
validators.ts
exec
/bin/zsh -lc "sed -n '1,220p' src/app/api/analyze/route.ts" in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 51ms:
import { NextResponse } from "next/server";
import { auth } from "@clerk/nextjs/server";
import { CheckRequestSchema } from "@/lib/validators";
import { readUsdtBlacklistStatusOnChain } from "@/lib/tron";
import { checkTronScanUsdtBlacklist } from "@/lib/tronscan";
import { checkOfacSanctions } from "@/lib/sanctions";
import { computeConfidencePercent, computeRiskScore, computeUsdtVolumeStats } from "@/lib/aml";
import { fetchTronScanAccountTag, fetchUsdtTrc20Transfers } from "@/lib/tronscan";
import { computeTopInboundCounterparties } from "@/lib/exposure";
import { computeFlowHeuristics } from "@/lib/heuristics";
import { getOrSetCache, sha256Key } from "@/lib/cache";
import { classifyEntityFromTagsAndTransfers } from "@/lib/entity";

export const runtime = "nodejs";

type Evidence = {
  contractAddress: string;
  txHash?: string;
  timestampIso?: string;
  method?: string;
exec
/bin/zsh -lc "sed -n '1,220p' src/app/api/check/route.ts" in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 62ms:
import { NextResponse } from "next/server";
import { CheckRequestSchema } from "@/lib/validators";
import { readUsdtBlacklistStatusOnChain } from "@/lib/tron";
import { checkTronScanUsdtBlacklist } from "@/lib/tronscan";

export const runtime = "nodejs";

type Evidence = {
  contractAddress: string;
  txHash?: string;
  timestampIso?: string;
  method?: string;
  raw?: string;
  fullHost?: string;
};

type CheckResult =
  | { ok: true; blacklisted: boolean; evidence?: Evidence }
  | { ok: false; blacklisted: false; error: string };




thinking
**Evaluating database configurations**

I’m noting that we already have a comment for `DATABASE_URL` for future reference. Next, I consider adding `ADDRESS_HASH_KEY` and `REPORT_RETENTION_DAYS`. If we choose Neon, it might only need `DATABASE_URL`, and Drizzle would too. I want to ensure the app builds even if `DATABASE_URL` is missing, which it does. We should document how missing values affect functionality. I'll clarify how reports are saved and what gets stored based on whether logging is enabled.
thinking
**Designing logging and storage protocols**

I need to clarify that if logging is disabled, we still return an analysis response, but nothing gets saved. I'll mention this aspect. Regarding `ADDRESS_HASH_KEY`, we can consistently store keyed hashes for indexing and deduplication. If logging is enabled, we might store raw addresses too, but that raises privacy concerns. If users want history, we can show addresses, perhaps encrypted. I'm thinking of storing `addressEnc` and `addressHash`, but we should prioritize keeping raw data private unless opted in. Ideally, we prefer encrypted storage for security.
thinking
**Clarifying storage and retention policies**

I’m considering whether we need additional environment variables for the storage requirements, but that might complicate the story. So, I might focus on just using a keyed hash. However, displaying the address in the UI could be tricky, especially if stored client-side. According to the PRD, I can keep both the address and addressHash if logging is enabled, but we might want privacy as the default. We also need to address retention policies, like unlimited retention by default and options like `REPORT_RETENTION_DAYS`. Lastly, I should create an ADR document and explore the existing documentation structure.
exec
/bin/zsh -lc "find . -maxdepth 3 -type d -name \"docs\" -o -name \"adr\" | sed -n '1,200p'" in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 72ms:



thinking
**Considering Neon setup**

I'm noting that if I'm using Neon on Vercel, I should opt for the Neon serverless driver or Postgres. I’ll go with Postgres and Drizzle for implementation. It's important to mention the missing DATABASE_URL: the DB client should only be created if the environment variable is present, otherwise, it should be `null`. Any routes needing the database need to check for it and return disabled if it’s missing. 

Next, I need to update the progress and activity logs. I’ll use `ralph log` for the activity log, but we’ve already attempted `./ralph` and an absolute path, so I won’t log that again. Moving on to step 2, I’ve found that `loggingEnabled` is only in localStorage. I plan to scan the PRD for retention details—it should be outlined there. For the ADR, I need to specify what gets stored when `loggingEnabled` is true or false. I want to ensure it aligns with what currently exists: if false, there should be no database writes or server logs of addresses.
thinking
**Planning logging and storage**

Even when logging is true, I should avoid logging raw data and instead only store it in the database as hashed values. I'll also detail which fields are persisted, like `SavedReport`, which includes `userId`, `address`, `addressHash`, and `reportJson`. I need an example record for clarity.

Next, I want to verify that in cases where the `DATABASE_URL` is missing, the features are disabled gracefully and that the application still builds properly; I should mention this in the documentation. 

I may modify the `.env.example` to include `ADDRESS_HASH_KEY`, `REPORT_RETENTION_DAYS`, and `MAX_REPORTS_PER_USER`, ensuring I add comments for clarity. `DATABASE_CONNECTION_LIMIT` could be included, but it might not be necessary.

I'll note that there are instructions in "AGENTS.md" to adhere to during the build and test process. I already have some instructions mentioned by the user, but it’s important to check the actual document to confirm. I’ll open that file to ensure I follow the correct guidelines and commands!
exec
/bin/zsh -lc "sed -n '1,220p' AGENTS.md" in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 56ms:
# Repository Guidelines

## Project Structure & Module Organization

- `src/app/`: Next.js App Router pages and API routes (e.g. `src/app/api/check/route.ts`, `src/app/api/analyze/route.ts`).
- `src/lib/`: Core screening logic (TRON/TronScan clients, sanctions screening, AML heuristics/scoring, validators). Unit tests are co-located as `*.test.ts`.
- `src/components/`: Reusable UI components (Tailwind CSS + shadcn/ui-style components).
- `src/data/`: Cached datasets (e.g. `src/data/ofac-tron-addresses.json`).
- `scripts/`: Maintenance scripts (e.g. OFAC dataset fetcher).
- `public/`: Static assets.

## Build, Test, and Development Commands

- `pnpm dev`: Run the local dev server at `http://localhost:3000`.
- `pnpm build` / `pnpm start`: Production build and run.
- `pnpm lint`: Run ESLint (Next.js core-web-vitals + TypeScript rules).
- `pnpm test`: Run Vitest once (Node environment).
- `pnpm test:watch`: Run tests in watch mode.
- `pnpm test:coverage`: Generate coverage output in `coverage/`.
- `pnpm ofac:update`: Refresh `src/data/ofac-tron-addresses.json` (requires network access).





thinking
**Planning documentation update**

I'm working on auditing the current environment and logging behavior, noting everything for the documentation. Next, I’ll need to write an ADR document and create new directories, using `apply_patch` for file additions. I'll also need to update the `.env.example`. Before all these changes, I'll log the major actions using `ralph log` for implementing the ADR document. I need to search for any existing documentation conventions, but it looks like there's no docs folder yet, so I'll create one.
thinking
**Deciding on database and hosting**

I'm considering using Vercel for hosting and a Node runtime. I've decided to go with Postgres, specifically Neon as the provider, and set up the `DATABASE_URL` environment variable. I plan to use Drizzle ORM with migration through drizzle-kit, as it offers a lighter, TypeScript-first approach with good serverless support. While Prisma has excellent developer experience and migration features, it introduces complexity with its heavy generator and binary requirements. I'll also set up a new `src/lib/db` folder to manage database interactions efficiently.
thinking
**Inspecting caching and report storage**

I noticed there's a cache that uses a SHA256 key with addresses. I need to check `cache.ts` to see if it's caching in memory, but it doesn’t store raw addresses since the key is hashed. However, I'm unsure if values might still include addresses, but those won't be persistent. 

When a user is authenticated and logging is enabled, upon clicking Save, the report will save to `SavedReport`, along with user settings. I’m planning to ensure that sensitive information is managed carefully, especially regarding third-party addresses in the saved report.
thinking
**Evaluating privacy and data storage**

I'm thinking that a privacy-first approach might require careful consideration about what fields we store when saving a report. Acceptance suggests providing a worked example, focusing on fields that persist. We could choose to store a normalized subset for compliance and privacy purposes. 

I wonder if we can keep the full JSON but redact counterparty addresses, which complicates evidence reproduction. Instead, we might store evidence links and only include limited addresses for top counterparties. While some public addresses on the chain might be okay, minimizing stored information is essential. Storing just a normalized subset like risk scores and timestamps may be a way to balance privacy while keeping useful output.
thinking
**Proposing report storage structure**

I’m thinking about storing the full `AnalyzeResponse` in `reportJson`, but replacing addresses and counterparties to maintain privacy. The PRD data model allows for a full JSON blob or a normalized subset. Since users have opted in, we might include linkable evidence without their addresses. It’s important to inform users that saving a report may involve storing public analyzed addresses, but we’ll avoid sensitive information like IP and user agent. 

Additionally, I’ll mention retention options for data and ensure we have comments in the `.env.example` for clarity. I need to make sure `ralph log` writes correctly to the activity log as well.
exec
/bin/zsh -lc 'cat .ralph/activity.log' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 55ms:
# Activity Log

## Run Summary

## Events

[2026-01-23 04:43:56] ITERATION 1 start (mode=build story=US-001)
[2026-01-23 04:45:25] Start US-001: decide DB+ORM and document retention policy
Plan update
  ✓ Review guardrails and prior errors
  ✓ Audit current env and logging behavior
  → Write ADR and retention policy doc
  • Update .env.example and validate build
  • Run lint, tests, and build
  • Commit, log activity, update progress
exec
/bin/zsh -lc 'ralph log "Draft ADR doc for DB/ORM decision + retention policy"' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 203ms:
Using local templates: /Users/chiko/side_projects/usdt_blacklisted_web/.agents/ralph
file update
A /Users/chiko/side_projects/usdt_blacklisted_web/docs/adr/0001-database-orm-and-retention.md
# ADR 0001: Postgres provider + ORM selection, and data retention policy

- **Status**: Accepted
- **Date**: 2026-01-23
- **Owner**: Maintainer
- **Related PRD items**: P2 opt-in report saving (History/Settings)

## Context

This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:

- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
- The ORM and migration tooling.
- The data retention and privacy policy for stored reports/settings.

Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.

## Decision

### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)

We standardize on Postgres with a `DATABASE_URL` connection string.

- **Recommended provider**: Neon (serverless Postgres).
- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.

**Rationale**

- Works well with Next.js + Vercel deployments.
- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
- Supports relational constraints + indexes needed for per-user history queries and deletion.

### ORM: Drizzle (TypeScript-first, minimal runtime)

We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.

**Rationale**

- Lightweight runtime (no heavy client generation step).
- Good TypeScript ergonomics; schema is code, migrations are explicit.
- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).

### Alternatives considered

#### Prisma

Pros:
- Excellent DX (schema, migrations, relations, introspection).
- Mature ecosystem.

Cons (why not chosen):
- Client generation step and heavier runtime footprint.
- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).

#### SQLite / Turso

Pros:
- Simple setup.

Cons:
- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.

## Data retention & privacy policy

### Definitions

- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.

### What is stored when `loggingEnabled` is false

When `loggingEnabled = false`:

- **No database writes occur** (no `UserSettings`, no `SavedReport`).
- The app still returns screening results normally; data exists only in memory for the request/response cycle.
- Do not add server logs that contain raw submitted addresses.

### What is stored when `loggingEnabled` is true

When `loggingEnabled = true` (and the user is authenticated):

- Store a `UserSettings` record for the user (`loggingEnabled = true`).
- Allow “Save report” actions to create `SavedReport` records.

**Data that SHOULD be stored**

- `userId` (Clerk user id)
- `address` (the analyzed TRON address; stored only when user opted in)
- `addressHash` (keyed hash for indexing/dedup; see below)
- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
- `reportJson` (either the `/api/analyze` response or a normalized subset)
- `createdAt`

**Data that MUST NOT be stored**

- Seed phrases, private keys, signatures.
- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
- Analytics events containing raw addresses.

### Address hashing (indexing without leaking raw identifiers)

Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:

- index reports by address without exposing raw addresses in indexes/logs,
- safely deduplicate (e.g., latest report per address),
- avoid storing raw addresses when users are not opted in.

Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.

### Retention policy

Default retention is **unlimited** (retain until the user deletes):

- Users can delete individual reports or delete all reports.
- This supports audit/history use cases.

Optional caps (operator-controlled):

- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.

If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.

## Worked example: saving a report

Assumptions:

- User is authenticated in Clerk as `user_2bQm...`.
- User enabled `loggingEnabled = true` in Settings.
- User analyzes address `TVjsdY...` via `/api/analyze`.

### Example persisted records

`UserSettings`:

```json
{
  "userId": "user_2bQm...",
  "loggingEnabled": true,
  "createdAt": "2026-01-23T05:10:00.000Z",
  "updatedAt": "2026-01-23T05:10:00.000Z"
}
```

`SavedReport` (normalized example):

```json
{
  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
  "userId": "user_2bQm...",
  "address": "TVjsdY...",
  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
  "riskScore": 72,
  "riskTier": "high",
  "confidence": 0.86,
  "window": { "lookbackDays": 30 },
  "reportJson": {
    "consensus": { "status": "not_blacklisted", "match": true },
    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
  },
  "createdAt": "2026-01-23T05:10:08.000Z"
}
```

Notes:

- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
- If `loggingEnabled = false`, none of the above rows are created.

## Negative case: `DATABASE_URL` missing

If `DATABASE_URL` is missing:

- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
- All persistence features are **disabled gracefully**:
  - “Save report” UI is hidden/disabled.
  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`

apply_patch(auto_approved=true) exited 0 in 44ms:
Success. Updated the following files:
A docs/adr/0001-database-orm-and-retention.md
file update:
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+

file update:
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+


thinking
**Updating documentation and environment**

I've got a document added, so now I need to update the `.env.example` file. That's part of step 4, but I think I can tackle it now. I'll follow the plan order: step 3 (the document update) is completed, and I’ll mark step 4 as in progress. It feels good to stay organized and keep track of what I’ve done and what’s next!
Plan update
  ✓ Review guardrails and prior errors
  ✓ Audit current env and logging behavior
  ✓ Write ADR and retention policy doc
  → Update .env.example and validate build
  • Run lint, tests, and build
  • Commit, log activity, update progress
file update:
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+

exec
/bin/zsh -lc 'ralph log "Update .env.example for chosen DB/ORM approach"' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 191ms:
Using local templates: /Users/chiko/side_projects/usdt_blacklisted_web/.agents/ralph
file update:
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+

file update
M /Users/chiko/side_projects/usdt_blacklisted_web/.env.example
@@ -13 +13,6 @@
 DATABASE_URL=
+ADDRESS_HASH_KEY=
+# Optional: retention cap for saved reports (default: unlimited)
+REPORT_RETENTION_DAYS=
+# Optional: cap saved reports per user (default: unlimited)
+MAX_REPORTS_PER_USER=
apply_patch(auto_approved=true) exited 0 in 37ms:
Success. Updated the following files:
M .env.example
file update:
diff --git a/.env.example b/.env.example
index bcce79ea1db8a6fc7f738ce8b4ef976998a29301..7ed569db077083e7e74930f91aaea33c8b69a368
--- a/.env.example
+++ b/.env.example
@@ -11,3 +11,8 @@
 
 # Database (future: opt-in report saving + credits)
 DATABASE_URL=
+ADDRESS_HASH_KEY=
+# Optional: retention cap for saved reports (default: unlimited)
+REPORT_RETENTION_DAYS=
+# Optional: cap saved reports per user (default: unlimited)
+MAX_REPORTS_PER_USER=
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+

file update:
diff --git a/.env.example b/.env.example
index bcce79ea1db8a6fc7f738ce8b4ef976998a29301..7ed569db077083e7e74930f91aaea33c8b69a368
--- a/.env.example
+++ b/.env.example
@@ -11,3 +11,8 @@
 
 # Database (future: opt-in report saving + credits)
 DATABASE_URL=
+ADDRESS_HASH_KEY=
+# Optional: retention cap for saved reports (default: unlimited)
+REPORT_RETENTION_DAYS=
+# Optional: cap saved reports per user (default: unlimited)
+MAX_REPORTS_PER_USER=
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+


thinking
**Validating the build process**

I need to validate the build, starting with updating the `.env.example` file. The quality gates will come later, so I want to check if the documentation is good first. I'll run the command `pnpm -s` to check for syntax issues, but I won't do the actual build yet. Step 4 needs to be completed first. I should consider handling cases where `DATABASE_URL` is missing, but for now, I'll mark step 4 as complete and move to step 5.
Plan update
  ✓ Review guardrails and prior errors
  ✓ Audit current env and logging behavior
  ✓ Write ADR and retention policy doc
  ✓ Update .env.example and validate build
  → Run lint, tests, and build
  • Commit, log activity, update progress
file update:
diff --git a/.env.example b/.env.example
index bcce79ea1db8a6fc7f738ce8b4ef976998a29301..7ed569db077083e7e74930f91aaea33c8b69a368
--- a/.env.example
+++ b/.env.example
@@ -11,3 +11,8 @@
 
 # Database (future: opt-in report saving + credits)
 DATABASE_URL=
+ADDRESS_HASH_KEY=
+# Optional: retention cap for saved reports (default: unlimited)
+REPORT_RETENTION_DAYS=
+# Optional: cap saved reports per user (default: unlimited)
+MAX_REPORTS_PER_USER=
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+

exec
/bin/zsh -lc 'ralph log "Run quality gates: pnpm lint/test/build"' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 165ms:
Using local templates: /Users/chiko/side_projects/usdt_blacklisted_web/.agents/ralph
file update:
diff --git a/.env.example b/.env.example
index bcce79ea1db8a6fc7f738ce8b4ef976998a29301..7ed569db077083e7e74930f91aaea33c8b69a368
--- a/.env.example
+++ b/.env.example
@@ -11,3 +11,8 @@
 
 # Database (future: opt-in report saving + credits)
 DATABASE_URL=
+ADDRESS_HASH_KEY=
+# Optional: retention cap for saved reports (default: unlimited)
+REPORT_RETENTION_DAYS=
+# Optional: cap saved reports per user (default: unlimited)
+MAX_REPORTS_PER_USER=
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+

exec
/bin/zsh -lc 'pnpm lint' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 2.75s:

> usdt_blacklisted_web@0.1.0 lint /Users/chiko/side_projects/usdt_blacklisted_web
> eslint

file update:
diff --git a/.env.example b/.env.example
index bcce79ea1db8a6fc7f738ce8b4ef976998a29301..7ed569db077083e7e74930f91aaea33c8b69a368
--- a/.env.example
+++ b/.env.example
@@ -11,3 +11,8 @@
 
 # Database (future: opt-in report saving + credits)
 DATABASE_URL=
+ADDRESS_HASH_KEY=
+# Optional: retention cap for saved reports (default: unlimited)
+REPORT_RETENTION_DAYS=
+# Optional: cap saved reports per user (default: unlimited)
+MAX_REPORTS_PER_USER=
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+

exec
/bin/zsh -lc 'pnpm test' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 1.06s:

> usdt_blacklisted_web@0.1.0 test /Users/chiko/side_projects/usdt_blacklisted_web
> vitest run


[1m[46m RUN [49m[22m [36mv4.0.17 [39m[90m/Users/chiko/side_projects/usdt_blacklisted_web[39m

 [32m✓[39m src/lib/heuristics.test.ts [2m([22m[2m3 tests[22m[2m)[22m[32m 2[2mms[22m[39m
 [32m✓[39m src/lib/exposure.test.ts [2m([22m[2m1 test[22m[2m)[22m[32m 3[2mms[22m[39m
 [32m✓[39m src/lib/aml.test.ts [2m([22m[2m7 tests[22m[2m)[22m[32m 4[2mms[22m[39m
 [32m✓[39m src/lib/sanctions.test.ts [2m([22m[2m2 tests[22m[2m)[22m[32m 6[2mms[22m[39m
 [32m✓[39m src/lib/entity.test.ts [2m([22m[2m2 tests[22m[2m)[22m[32m 2[2mms[22m[39m
 [32m✓[39m src/__tests__/api-analyze.test.ts [2m([22m[2m2 tests[22m[2m)[22m[32m 114[2mms[22m[39m

[2m Test Files [22m [1m[32m6 passed[39m[22m[90m (6)[39m
[2m      Tests [22m [1m[32m17 passed[39m[22m[90m (17)[39m
[2m   Start at [22m 04:48:04
[2m   Duration [22m 364ms[2m (transform 311ms, setup 0ms, import 549ms, tests 131ms, environment 0ms)[22m

(node:12413) ExperimentalWarning: CommonJS module /Users/chiko/side_projects/usdt_blacklisted_web/node_modules/.pnpm/vitest@4.0.17_@types+node@20.19.30_jiti@2.6.1_lightningcss@1.30.2/node_modules/vitest/dist/config.cjs is loading ES Module /Users/chiko/side_projects/usdt_blacklisted_web/node_modules/.pnpm/vite@7.3.1_@types+node@20.19.30_jiti@2.6.1_lightningcss@1.30.2/node_modules/vite/dist/node/index.js using require().
file update:
diff --git a/.env.example b/.env.example
index bcce79ea1db8a6fc7f738ce8b4ef976998a29301..7ed569db077083e7e74930f91aaea33c8b69a368
--- a/.env.example
+++ b/.env.example
@@ -11,3 +11,8 @@
 
 # Database (future: opt-in report saving + credits)
 DATABASE_URL=
+ADDRESS_HASH_KEY=
+# Optional: retention cap for saved reports (default: unlimited)
+REPORT_RETENTION_DAYS=
+# Optional: cap saved reports per user (default: unlimited)
+MAX_REPORTS_PER_USER=
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+

exec
/bin/zsh -lc 'pnpm build' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 7.71s:

> usdt_blacklisted_web@0.1.0 build /Users/chiko/side_projects/usdt_blacklisted_web
> next build

▲ Next.js 16.1.4 (Turbopack)
- Environments: .env

  Creating an optimized production build ...
✓ Compiled successfully in 3.6s
  Running TypeScript ...
  Collecting page data using 7 workers ...
  Generating static pages using 7 workers (0/6) ...
  Generating static pages using 7 workers (1/6) 
  Generating static pages using 7 workers (2/6) 
  Generating static pages using 7 workers (4/6) 
✓ Generating static pages using 7 workers (6/6) in 195.2ms
  Finalizing page optimization ...

Route (app)
┌ ○ /
file update:
diff --git a/.env.example b/.env.example
index bcce79ea1db8a6fc7f738ce8b4ef976998a29301..7ed569db077083e7e74930f91aaea33c8b69a368
--- a/.env.example
+++ b/.env.example
@@ -11,3 +11,8 @@
 
 # Database (future: opt-in report saving + credits)
 DATABASE_URL=
+ADDRESS_HASH_KEY=
+# Optional: retention cap for saved reports (default: unlimited)
+REPORT_RETENTION_DAYS=
+# Optional: cap saved reports per user (default: unlimited)
+MAX_REPORTS_PER_USER=
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+


thinking
**Updating progress**

All quality gates have passed, and there’s a node warning about ESM, which is unrelated. I might note it in the learnings, but it's not essential. Now that step 5 is complete, I’m moving on to step 6. I need to commit changes using the commit skill and check the activity log after logging tests earlier. We should log after making major code changes too, like drafting ADR and updating env. Time to focus on committing!
Plan update
  ✓ Review guardrails and prior errors
  ✓ Audit current env and logging behavior
  ✓ Write ADR and retention policy doc
  ✓ Update .env.example and validate build
  ✓ Run lint, tests, and build
  → Commit, log activity, update progress
file update:
diff --git a/.env.example b/.env.example
index bcce79ea1db8a6fc7f738ce8b4ef976998a29301..7ed569db077083e7e74930f91aaea33c8b69a368
--- a/.env.example
+++ b/.env.example
@@ -11,3 +11,8 @@
 
 # Database (future: opt-in report saving + credits)
 DATABASE_URL=
+ADDRESS_HASH_KEY=
+# Optional: retention cap for saved reports (default: unlimited)
+REPORT_RETENTION_DAYS=
+# Optional: cap saved reports per user (default: unlimited)
+MAX_REPORTS_PER_USER=
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+

exec
/bin/zsh -lc "sed -n '1,200p' /Users/chiko/.codex/skills/commit/SKILL.md" in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 54ms:
---
name: commit
description: Write conventional commit messages with type, scope, and subject when the user wants to commit changes or save work.
---

# Git Commit

Creates git commits following Conventional Commits format with proper type, scope, and subject.

## Quick Start

```bash
# 1. Stage changes
git add <files>  # or: git add -A

# 2. Create commit (branch commit format)
git commit -m "type(scope): subject

Body explaining HOW and WHY.
Reference: Task X.Y, Req N"
file update:
diff --git a/.env.example b/.env.example
index bcce79ea1db8a6fc7f738ce8b4ef976998a29301..7ed569db077083e7e74930f91aaea33c8b69a368
--- a/.env.example
+++ b/.env.example
@@ -11,3 +11,8 @@
 
 # Database (future: opt-in report saving + credits)
 DATABASE_URL=
+ADDRESS_HASH_KEY=
+# Optional: retention cap for saved reports (default: unlimited)
+REPORT_RETENTION_DAYS=
+# Optional: cap saved reports per user (default: unlimited)
+MAX_REPORTS_PER_USER=
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+


thinking
**Reviewing Git Commit Process**

I'm preparing to commit story changes using the conventional commit message format, which includes the type, scope, and subject. First, I need to stage my changes with `git add -A`. Before making the commit, I'll check the status with `git status` and examine the differences with `git diff`. After that, I'll log major actions using the ralph log. I’ll make sure everything is in order before proceeding.
exec
/bin/zsh -lc 'git status --porcelain' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 84ms:
 M .env.example
 M .ralph/activity.log
?? .agents/ralph/
?? .agents/tasks/prd-optin-dashboard.overview.md
?? .agents/tasks/prd-post-mvp.json
?? .ralph/.tmp/prd-prompt-20260123-043736-96875.md
?? .ralph/.tmp/prompt-20260123-044356-6274-1.md
?? .ralph/.tmp/story-20260123-043424-92605-1.json
?? .ralph/.tmp/story-20260123-043424-92605-1.md
?? .ralph/.tmp/story-20260123-043705-96152-1.json
?? .ralph/.tmp/story-20260123-043705-96152-1.md
?? .ralph/.tmp/story-20260123-044356-6274-1.json
?? .ralph/.tmp/story-20260123-044356-6274-1.md
?? .ralph/runs/
?? docs/
exec
/bin/zsh -lc 'git diff' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 41ms:
diff --git a/.env.example b/.env.example
index bcce79e..7ed569d 100644
--- a/.env.example
+++ b/.env.example
@@ -11,3 +11,8 @@ NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/
 
 # Database (future: opt-in report saving + credits)
 DATABASE_URL=
+ADDRESS_HASH_KEY=
+# Optional: retention cap for saved reports (default: unlimited)
+REPORT_RETENTION_DAYS=
+# Optional: cap saved reports per user (default: unlimited)
+MAX_REPORTS_PER_USER=
diff --git a/.ralph/activity.log b/.ralph/activity.log
index f4d0317..ff3cc12 100644
--- a/.ralph/activity.log
+++ b/.ralph/activity.log
@@ -4,3 +4,8 @@
 
 ## Events
exec
/bin/zsh -lc 'git diff --stat' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 60ms:
 .env.example        | 5 +++++
 .ralph/activity.log | 5 +++++
 2 files changed, 10 insertions(+)
file update:
diff --git a/.env.example b/.env.example
index bcce79ea1db8a6fc7f738ce8b4ef976998a29301..7ed569db077083e7e74930f91aaea33c8b69a368
--- a/.env.example
+++ b/.env.example
@@ -11,3 +11,8 @@
 
 # Database (future: opt-in report saving + credits)
 DATABASE_URL=
+ADDRESS_HASH_KEY=
+# Optional: retention cap for saved reports (default: unlimited)
+REPORT_RETENTION_DAYS=
+# Optional: cap saved reports per user (default: unlimited)
+MAX_REPORTS_PER_USER=
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+

exec
/bin/zsh -lc 'cat .gitignore' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 61ms:
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
file update:
diff --git a/.env.example b/.env.example
index bcce79ea1db8a6fc7f738ce8b4ef976998a29301..7ed569db077083e7e74930f91aaea33c8b69a368
--- a/.env.example
+++ b/.env.example
@@ -11,3 +11,8 @@
 
 # Database (future: opt-in report saving + credits)
 DATABASE_URL=
+ADDRESS_HASH_KEY=
+# Optional: retention cap for saved reports (default: unlimited)
+REPORT_RETENTION_DAYS=
+# Optional: cap saved reports per user (default: unlimited)
+MAX_REPORTS_PER_USER=
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+


thinking
**Evaluating git files**

It looks like `.gitignore` doesn't ignore certain files like `.agents`, `.ralph`, or the `docs` folder, so if I run `git add -A`, they would be staged for commit. While step 10 instructs to stage everything and commit, I'm wondering if these files contain sensitive information. For instance, `.ralph/.tmp/...` might have prompts or secrets. I need to quickly review these files for any environment values or sensitive keys, and I'll use `rg` to check for patterns like "CLERK_SECRET_KEY."
exec
/bin/zsh -lc 'rg -n "SECRET|KEY=|DATABASE_URL=|CLERK" .ralph/.tmp .ralph/runs .agents/ralph .agents/tasks/prd-post-mvp.json -S || true' in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 73ms:
.ralph/runs/run-20260123-044356-6274-iter-1.log:321:./project_summary.md:851:DATABASE_URL=
.ralph/runs/run-20260123-044356-6274-iter-1.log:328:TRONGRID_API_KEY=
.ralph/runs/run-20260123-044356-6274-iter-1.log:332:NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=
.ralph/runs/run-20260123-044356-6274-iter-1.log:333:CLERK_SECRET_KEY=
.ralph/runs/run-20260123-044356-6274-iter-1.log:334:NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
.ralph/runs/run-20260123-044356-6274-iter-1.log:335:NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
.ralph/runs/run-20260123-044356-6274-iter-1.log:336:NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/
.ralph/runs/run-20260123-044356-6274-iter-1.log:337:NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/
.ralph/runs/run-20260123-044356-6274-iter-1.log:340:DATABASE_URL=
.ralph/runs/run-20260123-044356-6274-iter-1.log:440:  const clerkEnabled = Boolean(process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY);
.ralph/runs/run-20260123-044356-6274-iter-1.log:1576: DATABASE_URL=
.ralph/runs/run-20260123-044356-6274-iter-1.log:1577:+ADDRESS_HASH_KEY=
.ralph/runs/run-20260123-044356-6274-iter-1.log:1593: DATABASE_URL=
.ralph/runs/run-20260123-044356-6274-iter-1.log:1594:+ADDRESS_HASH_KEY=
.ralph/runs/run-20260123-044356-6274-iter-1.log:1795: DATABASE_URL=
.ralph/runs/run-20260123-044356-6274-iter-1.log:1796:+ADDRESS_HASH_KEY=
.ralph/runs/run-20260123-044356-6274-iter-1.log:2009: DATABASE_URL=
.ralph/runs/run-20260123-044356-6274-iter-1.log:2010:+ADDRESS_HASH_KEY=
.ralph/runs/run-20260123-044356-6274-iter-1.log:2214: DATABASE_URL=
.ralph/runs/run-20260123-044356-6274-iter-1.log:2215:+ADDRESS_HASH_KEY=
file update:
diff --git a/.env.example b/.env.example
index bcce79ea1db8a6fc7f738ce8b4ef976998a29301..7ed569db077083e7e74930f91aaea33c8b69a368
--- a/.env.example
+++ b/.env.example
@@ -11,3 +11,8 @@
 
 # Database (future: opt-in report saving + credits)
 DATABASE_URL=
+ADDRESS_HASH_KEY=
+# Optional: retention cap for saved reports (default: unlimited)
+REPORT_RETENTION_DAYS=
+# Optional: cap saved reports per user (default: unlimited)
+MAX_REPORTS_PER_USER=
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+

exec
/bin/zsh -lc "ls -la .ralph/runs | sed -n '1,120p'" in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 64ms:
total 400
drwxr-xr-x@ 3 chiko  staff      96 Jan 23 04:43 .
drwxr-xr-x@ 8 chiko  staff     256 Jan 23 04:25 ..
-rw-r--r--@ 1 chiko  staff  173441 Jan 23 04:48 run-20260123-044356-6274-iter-1.log
file update:
diff --git a/.env.example b/.env.example
index bcce79ea1db8a6fc7f738ce8b4ef976998a29301..7ed569db077083e7e74930f91aaea33c8b69a368
--- a/.env.example
+++ b/.env.example
@@ -11,3 +11,8 @@
 
 # Database (future: opt-in report saving + credits)
 DATABASE_URL=
+ADDRESS_HASH_KEY=
+# Optional: retention cap for saved reports (default: unlimited)
+REPORT_RETENTION_DAYS=
+# Optional: cap saved reports per user (default: unlimited)
+MAX_REPORTS_PER_USER=
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+

exec
/bin/zsh -lc "sed -n '1,200p' .agents/ralph/README.md" in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 71ms:
# Ralph

![Ralph](ralph.webp)

Ralph is a minimal, file‑based agent loop for autonomous coding. Each iteration starts fresh, reads the same on‑disk state, and commits work for one story at a time.

## How it works

Ralph treats **files and git** as memory, not the model context:

- **PRD (JSON)** defines stories, gates, and status
- **Loop** executes one story per iteration
- **State** persists in `.ralph/`

![Ralph architecture](diagram.svg)

## Global CLI (recommended)

Install and run Ralph from anywhere:

file update:
diff --git a/.env.example b/.env.example
index bcce79ea1db8a6fc7f738ce8b4ef976998a29301..7ed569db077083e7e74930f91aaea33c8b69a368
--- a/.env.example
+++ b/.env.example
@@ -11,3 +11,8 @@
 
 # Database (future: opt-in report saving + credits)
 DATABASE_URL=
+ADDRESS_HASH_KEY=
+# Optional: retention cap for saved reports (default: unlimited)
+REPORT_RETENTION_DAYS=
+# Optional: cap saved reports per user (default: unlimited)
+MAX_REPORTS_PER_USER=
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+



thinking
**Evaluating commit options**

I'm thinking about whether to keep certain files in my gitignore. The `README` mentions that `.ralph` state persists, so it might need to be committed. The instructions suggest I commit changes to progress and logs, but not necessarily temp prompts. If I use `git add -A`, it will stage everything, but I wonder if temporary files are necessary for debugging. They might clutter the repo, yet it seems the harness expects them. Maybe the `.ralph/.tmp` directory should be ignored, but it currently isn't.
thinking
**Deciding on commit strategy**

I'm contemplating what to commit based on the instructions. They suggest committing progress and activity logs, but maybe `.tmp` files are just temporary and can be deleted to reduce clutter. However, deleting those files would also count as a change, which could create conflicts. It seems I'm expected to commit everything created, including `.tmp`. Still, I need to check that there are no sensitive details in `.agents/ralph` or `.ralph/.tmp`, so I should quickly inspect the content.
exec
/bin/zsh -lc "ls -la .ralph/.tmp | sed -n '1,200p'" in /Users/chiko/side_projects/usdt_blacklisted_web succeeded in 62ms:
total 80
drwxr-xr-x@ 15 chiko  staff   480 Jan 23 04:43 .
drwxr-xr-x@  8 chiko  staff   256 Jan 23 04:25 ..
-rw-r--r--@  1 chiko  staff   524 Jan 23 04:21 prd-prompt-20260123-042148-75244.md
-rw-r--r--@  1 chiko  staff   512 Jan 23 04:37 prd-prompt-20260123-043736-96875.md
-rw-r--r--@  1 chiko  staff  7708 Jan 23 04:43 prompt-20260123-044356-6274-1.md
-rw-r--r--@  1 chiko  staff    56 Jan 23 04:25 story-20260123-042526-80680-1.json
-rw-r--r--@  1 chiko  staff     0 Jan 23 04:25 story-20260123-042526-80680-1.md
-rw-r--r--@  1 chiko  staff    56 Jan 23 04:26 story-20260123-042600-81451-1.json
-rw-r--r--@  1 chiko  staff     0 Jan 23 04:26 story-20260123-042600-81451-1.md
-rw-r--r--@  1 chiko  staff    56 Jan 23 04:34 story-20260123-043424-92605-1.json
-rw-r--r--@  1 chiko  staff     0 Jan 23 04:34 story-20260123-043424-92605-1.md
-rw-r--r--@  1 chiko  staff    56 Jan 23 04:37 story-20260123-043705-96152-1.json
-rw-r--r--@  1 chiko  staff     0 Jan 23 04:37 story-20260123-043705-96152-1.md
-rw-r--r--@  1 chiko  staff   216 Jan 23 04:43 story-20260123-044356-6274-1.json
-rw-r--r--@  1 chiko  staff  1002 Jan 23 04:43 story-20260123-044356-6274-1.md
file update:
diff --git a/.env.example b/.env.example
index bcce79ea1db8a6fc7f738ce8b4ef976998a29301..7ed569db077083e7e74930f91aaea33c8b69a368
--- a/.env.example
+++ b/.env.example
@@ -11,3 +11,8 @@
 
 # Database (future: opt-in report saving + credits)
 DATABASE_URL=
+ADDRESS_HASH_KEY=
+# Optional: retention cap for saved reports (default: unlimited)
+REPORT_RETENTION_DAYS=
+# Optional: cap saved reports per user (default: unlimited)
+MAX_REPORTS_PER_USER=
diff --git a/docs/adr/0001-database-orm-and-retention.md b/docs/adr/0001-database-orm-and-retention.md
new file mode 100644
index 0000000000000000000000000000000000000000..1336e52bd4a42efb6f8e2a30c6038ff3b9775794
--- /dev/null
+++ b/docs/adr/0001-database-orm-and-retention.md
@@ -0,0 +1,181 @@
+# ADR 0001: Postgres provider + ORM selection, and data retention policy
+
+- **Status**: Accepted
+- **Date**: 2026-01-23
+- **Owner**: Maintainer
+- **Related PRD items**: P2 opt-in report saving (History/Settings)
+
+## Context
+
+This app performs TRON address screening via `/api/check` and `/api/analyze`. A future P2 feature will allow authenticated users to opt in to saving reports (History) and storing a `loggingEnabled` preference (Settings). To keep that implementation consistent and privacy-first, we need a single decision for:
+
+- The Postgres provider approach (Vercel-friendly, `DATABASE_URL` compatible).
+- The ORM and migration tooling.
+- The data retention and privacy policy for stored reports/settings.
+
+Non-goal: implement report saving in this ADR. This ADR defines the contract for future implementation.
+
+## Decision
+
+### Database provider: Postgres via `DATABASE_URL` (recommend Neon; compatible with Vercel Postgres)
+
+We standardize on Postgres with a `DATABASE_URL` connection string.
+
+- **Recommended provider**: Neon (serverless Postgres).
+- **Also compatible**: Vercel Postgres, any managed Postgres that provides `DATABASE_URL`.
+
+**Rationale**
+
+- Works well with Next.js + Vercel deployments.
+- Keeps infra flexible (provider swap is a config change as long as `DATABASE_URL` remains Postgres-compatible).
+- Supports relational constraints + indexes needed for per-user history queries and deletion.
+
+### ORM: Drizzle (TypeScript-first, minimal runtime)
+
+We standardize on **Drizzle ORM** (plus `drizzle-kit` for migrations) for the report-saving data model.
+
+**Rationale**
+
+- Lightweight runtime (no heavy client generation step).
+- Good TypeScript ergonomics; schema is code, migrations are explicit.
+- Fits this codebase’s preference to keep logic in `src/lib/` and API routes thin.
+- Works cleanly in **Node.js runtime** (current API routes explicitly set `export const runtime = "nodejs";`).
+
+### Alternatives considered
+
+#### Prisma
+
+Pros:
+- Excellent DX (schema, migrations, relations, introspection).
+- Mature ecosystem.
+
+Cons (why not chosen):
+- Client generation step and heavier runtime footprint.
+- Extra operational considerations in serverless environments (engines/binaries or proxy/accelerate choices).
+
+#### SQLite / Turso
+
+Pros:
+- Simple setup.
+
+Cons:
+- Less aligned with the PRD’s Postgres assumption and future multi-tenant/history query patterns.
+
+## Data retention & privacy policy
+
+### Definitions
+
+- **loggingEnabled**: user-controlled, explicit opt-in to saving data server-side. Default is **false**.
+- **Saved report**: a persisted record associated to a Clerk user, derived from an `/api/analyze` result.
+
+### What is stored when `loggingEnabled` is false
+
+When `loggingEnabled = false`:
+
+- **No database writes occur** (no `UserSettings`, no `SavedReport`).
+- The app still returns screening results normally; data exists only in memory for the request/response cycle.
+- Do not add server logs that contain raw submitted addresses.
+
+### What is stored when `loggingEnabled` is true
+
+When `loggingEnabled = true` (and the user is authenticated):
+
+- Store a `UserSettings` record for the user (`loggingEnabled = true`).
+- Allow “Save report” actions to create `SavedReport` records.
+
+**Data that SHOULD be stored**
+
+- `userId` (Clerk user id)
+- `address` (the analyzed TRON address; stored only when user opted in)
+- `addressHash` (keyed hash for indexing/dedup; see below)
+- `riskScore`, `riskTier`, `confidence` (duplicated from `reportJson` for fast list queries)
+- `reportJson` (either the `/api/analyze` response or a normalized subset)
+- `createdAt`
+
+**Data that MUST NOT be stored**
+
+- Seed phrases, private keys, signatures.
+- IP address, user-agent, or other request metadata (unless explicitly added later with a separate ADR).
+- Analytics events containing raw addresses.
+
+### Address hashing (indexing without leaking raw identifiers)
+
+Persist an `addressHash` computed as a **keyed hash** (HMAC) so we can:
+
+- index reports by address without exposing raw addresses in indexes/logs,
+- safely deduplicate (e.g., latest report per address),
+- avoid storing raw addresses when users are not opted in.
+
+Recommended: `addressHash = HMAC_SHA256(ADDRESS_HASH_KEY, normalizedAddress)` encoded as hex/base64url.
+
+### Retention policy
+
+Default retention is **unlimited** (retain until the user deletes):
+
+- Users can delete individual reports or delete all reports.
+- This supports audit/history use cases.
+
+Optional caps (operator-controlled):
+
+- `REPORT_RETENTION_DAYS` (optional): if set, delete reports older than N days.
+- `MAX_REPORTS_PER_USER` (optional): if set, enforce a maximum number of reports per user by deleting oldest first.
+
+If caps are enabled, enforce them via a scheduled job (e.g., Vercel Cron) and/or at write time.
+
+## Worked example: saving a report
+
+Assumptions:
+
+- User is authenticated in Clerk as `user_2bQm...`.
+- User enabled `loggingEnabled = true` in Settings.
+- User analyzes address `TVjsdY...` via `/api/analyze`.
+
+### Example persisted records
+
+`UserSettings`:
+
+```json
+{
+  "userId": "user_2bQm...",
+  "loggingEnabled": true,
+  "createdAt": "2026-01-23T05:10:00.000Z",
+  "updatedAt": "2026-01-23T05:10:00.000Z"
+}
+```
+
+`SavedReport` (normalized example):
+
+```json
+{
+  "id": "9a1f3d0e-8b7c-4a14-a2e6-9ff3d5d6c17a",
+  "userId": "user_2bQm...",
+  "address": "TVjsdY...",
+  "addressHash": "hmacsha256:9f7b0b5b... (derived from ADDRESS_HASH_KEY + normalized address)",
+  "riskScore": 72,
+  "riskTier": "high",
+  "confidence": 0.86,
+  "window": { "lookbackDays": 30 },
+  "reportJson": {
+    "consensus": { "status": "not_blacklisted", "match": true },
+    "risk": { "score": 72, "tier": "high", "confidence": 0.86 },
+    "timestamps": { "checkedAtIso": "2026-01-23T05:10:07.123Z" },
+    "checks": { "tronscan": { "ok": true, "blacklisted": false }, "onchain": { "ok": true, "blacklisted": false } }
+  },
+  "createdAt": "2026-01-23T05:10:08.000Z"
+}
+```
+
+Notes:
+
+- `reportJson` can be the full `/api/analyze` payload or a normalized subset; duplication of `riskScore/riskTier/confidence` supports fast “History list” queries without JSON parsing.
+- If `loggingEnabled = false`, none of the above rows are created.
+
+## Negative case: `DATABASE_URL` missing
+
+If `DATABASE_URL` is missing:
+
+- The app must still **build and run** screening endpoints (`/api/check`, `/api/analyze`) normally.
+- All persistence features are **disabled gracefully**:
+  - “Save report” UI is hidden/disabled.
+  - Any API route that would write/read persisted reports returns a clear error such as `503` with `Persistence is disabled (DATABASE_URL not set).`
+



thinking
**Evaluating commit decisions**

I'm considering the ralph scaffolding and task files that might not have been changed by us but are in the repo. They could have been created in earlier runs. The story only needs documentation and environment updates, yet we might need to include all created files and logs in our commit. There's a tension here, as those files aren't part of the story. However, user instructions require committing all changes, so I'll comply even if it feels a bit off.
thinking
**Crafting commit message**

I'm working on the commit message and thinking it could be `docs(adr): decide postgres+drizzle and retention` for the changes related to the story. The scope might be `adr` or `config`, as it includes the .env.example file too. I see that `docs(adr): decide database and retention policy` fits well within the limits. I’ll also reference US-001 in the body and mention updating the env example. Before staging everything, I'll check to ensure that no secrets are included. It looks good!
exec
/bin/zsh -lc 'git add -A' in /Users/chiko/side_projects/usdt_blacklisted_web